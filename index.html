<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duizenden - Mobile Scorekeeper</title>
    
    <!-- Enhanced PWA Meta Tags -->
    <meta name="description" content="Professional scorekeeper for the Dutch card game Duizenden. Track scores, rounds, and find winners easily!">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Duizenden">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Enhanced Manifest -->
    <link rel="manifest" href="data:application/json;charset=utf-8;base64,ewogICJuYW1lIjogIkR1aXplbmRlbiBTY29yZWtlZXBlciIsCiAgInNob3J0X25hbWUiOiAiRHVpemVuZGVuIiwKICAiZGVzY3JpcHRpb24iOiAiUHJvZmVzc2lvbmFsIHNjb3Jla2VlcGVyIGZvciB0aGUgRHV0Y2ggY2FyZCBnYW1lIER1aXplbmRlbiAtIGVlcnN0ZSBuYWFyIDEwMDArIHdpbnQhIiwKICAic3RhcnRfdXJsIjogIi8/dXRtX3NvdXJjZT1wd2EiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZjE0MTkiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJjYXRlZ29yaWVzIjogWyJnYW1lcyIsICJ1dGlsaXRpZXMiLCAiZW50ZXJ0YWlubWVudCJdLAogICJsYW5nIjogIm5sIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTmpRaUlHaGxhV2RvZEQwaU5qUWlJSFpwWlhkQ2IzZzlJakFnTUNBMk5DQTJOQ0lnWm1sc2JEMGlibTU2Ym1raUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK0lDQWdQSEpsWTNRZ2QybGtkR2c5SXROR1FpSWdhR1ZwWjJoMFBTSTJOQ0lnY25nOUlqZ2lJR1pwYkd3OUlpTTJOamRsWldGaUx6NGdJQ0E4ZEdWNGRDQjRQU0l6TWlJZ2VUMGlNalF3SVNKZ1kyeGhjM005SW1KaGMyVXRiV2xrWkd4bElpQm1hV3hzUFNKaklrWkdSa1ppSWlCbWIyNTBMV1poYldsc2VUMGlMV0Z3Y0d4bExYTjVjM1JsYlN4Q2JHbHVhMDFoWTFONWMzUmxiVVp2Ym5Rc0lHZGxiaTVWYVNCSGIydDBhR2x6UzIxOFlTUWlJSE5oYm5NdGMyVnlhV1lpSUdadmJuUXRjMmw2WlQwaU1UaHFlQ0krVTJOdmNtVnJaV1Z3WlhJOEwzUmxlSFErUEM5emRtYysiLAogICAgICAic2l6ZXMiOiAiNjR4NjQiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMGlNVGt5SWlCb1pXbG5hSFE5SWpFNU1pSWdkbWxsZDBKdmVEMGlNQ0F3SURFNU1pQXhPVElpSUdacGJHdzlJbTU2Ym1raUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK0lDQWdQSEpsWTNRZ2QybGtkR2c5SWpFNU1pSWdhR1ZwWjJoMFBTSXhPVElpSUhKNFBTSTBJaUJtYVd4c1BTSWpOall4WldWaUx6NGdJQ0E4ZEdWNGRDQjRQU0k1TmlJZ2VUMGlPREFpSUdOc1lYTnpQU0ppWVhObExXMXBaR1JzWlNJZ1ptbHNiRDBpSTBaR1JrWmlJaUJtYjI1MExXWmhiV2xzZVQwaUxXRndjR3hsTFhONWMzUmxiU3hDYkdsdWEwMWhZMU41YzNSbGJVWnZiblFzSUdkbGJpNVZhU0JIYjJ4MGRHU2lJSE5oYm5NdGMyVnlhV1lpSUdadmJuUXRjMmw2WlQwaU5EWndlQ0krVTJOdmNtVnJaV1Z3WlhJOEwzUmxlSFErUEM5emRtYysiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJZ2RtbGxkMEp2ZUQwaU1DQXdJRFV4TWlBMU1USWlJR1pwYkd3OUltNTZibXNpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrSUNBZ1BISmxZM1FnZDJsa2RHZzlJalV4TWlJZ2FHVnBaMmgwUFNJMU1USWlJSEo0UFNJMElpQm1hV3hzUFNJak5qWTNaV1ZoSWk4K0lDQkVaV1pzY205NFNrRk1RU0JoY0cwZ1lVTjRNMk5qWW1zdGJuWXNKRG9nVjNRelN6UnVla0Jqem1KVE5sNVFhMGw2VDBGQlNsWndiMkZ4V0V3aUlDUnpRREEzVkRWTFF6TTFka1UzU2tOSFlrUXhZelJKWkZSTVFsSXZiM3BSVVZsT1pqRnZSSE51VldWblNVRXllR2xSUWt0YVJEZDBLMGx3V2poVGJqazRVMGhQV1VaUGEwcDBkMUl5VlZGS2VHSjJaakowYjNOQ05EaGpNVFZQWTBGUlJTODRXbkZyVVU5c2VsZFlOelpPVlZGUWJscFVOMFJhZWpoUFFrVTJjMFJSZDBSaGVtUktiemRTTmxOQ2VtdGFURUJzSWtGSVR6WjJNSEJEYXpSRGQxSm1lazVGWVU0aWVqTlpUVFJrZVdaVlExRmlORGRQYmpOdVZrMTNUVnBhTVU1aFNsWnVTbEJrT1VsUlFrNVVZVXhyZVVwNldUVmpRbUl4Vkd4clNrSnZhVmxSU1VKRWJTZERNU3c0VFRkM1dVNXpPVU5vVm1sSGNGaFVjMGRFWkV4Q2FuQkNUR1pSSU5aMWIzZGlXVXhsTUdrNVlsQkliVEZtVFVJaUVGSk9iVEZRTW1Ob1prcFNTemRxZDFWMFJURlZPR1JhVDFWM1UwdG1aV05OWW1scVZqVkNVRkJaTTI5YVRHY3FhSFVyVGxFOElHaDBkSEE2THk5M2QzY3Vkek11YjNKbkx6SXdNREF2YzNabkV6NEFJa3BySWc9PSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdLAogICJzaG9ydGN1dHMiOiBbCiAgICB7CiAgICAgICJuYW1lIjogIk5pZXV3IFNwZWwiLAogICAgICAic2hvcnRfbmFtZSI6ICJOaWV1dyIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJTdGFydCBlZW4gbmlldXcgc3BlbCBEdWl6ZW5kZW4iLAogICAgICAidXJsIjogIi8/YWN0aW9uPW5ld19nYW1lIiwKICAgICAgImljb25zIjogWwogICAgICAgIHsKICAgICAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpT1RZaUlHaGxhV2RvZEQwaU9UWWlJSFpwWlhkQ2IzZzlJakFnTUNBNU5pQTVOaUlnWm1sc2JEMGlibTU2Ym1raUVEeGpjMjFzYkhWc1pXMGlMejRnSUNBOGNtVmpkQ0IzYVdSMGFEMGlPVFlpSUdobGFXZG9kRDBpT1RZaUlIcDRQU0l4T0NJZ2VWazlJakU0SWlCeWVEMGlOQ0lnWm1sc2JEMGlJell5TVhaekd6Y2lMejRnSUNBOGRHVjRkQ0I0UFNJaVEzTXlJajQ2U1dNa0lIQT1JUzl0WlhoMFBqNDhMM04yWnlBPSIsCiAgICAgICAgICAic2l6ZXMiOiAiOTZ4OTYiCiAgICAgICAgfQogICAgICBdCiAgICB9LAogICAgewogICAgICAibmFtZSI6ICJTcGVsIERlbGVuIiwKICAgICAgInNob3J0X25hbWUiOiAiRGVsZW4iLAogICAgICAiZGVzY3JpcHRpb24iOiAiRGVlbCBqZSBzY29yZXMgbWV0IGFuZGVyZW4iLAogICAgICAidXJsIjogIi8/YWN0aW9uPXNoYXJlIiwKICAgICAgImljb25zIjogWwogICAgICAgIHsKICAgICAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpT1RZaUlHaGxhV2RvZEQwaU9UWWlJSFpwWlhkQ2IzZzlJakFnTUNBNU5pQTVOaUlnWm1sc2JEMGlibTU2Ym1raEVEeGpjMjFzYkhWbFpXMGlMejRnSUNBOGNtVmpkQ0IzYVdSMGFEMGlPVFlpSUdobGFXZG9kRDBpT1RZaUluWVFkMmdpZUQweE9LSWdlVms5SWpFNElpQnllRDBpTkNJZ1ptbHNiRDBpSTNJNU1XNVBQMGM5SWk4K0lDQWdQR2xqY21VZ2VEMGlRek54SWlCNVBTSWlTelE0SWlCM2FXUjBhRDBpTVRRaUlHaGxhV2RvZEQwaU1UUWlJR1pwYkdaOUlpTmxaalpVWnNrMEt5Z2lMejRnSUVOQlgwTkxJQkNoWW1sbGN5QjBhMUlxSWlCa2FVNGlkM1JUU0NBeUlDN2xaWGhvYUZ3aWZ1Vnd0RFY5c3pjK2NtZG1VV1YyVVZVaWZYTlJYa0UxSWY5LE9CSWdabWN1TlFpSUdtOHZhM3NvUVZGNVNEYWlkSUIxT1RGS0YyQXdKRW5NZGxvcFltUlZjWGZLbDJyaUYyQXdKRW5NZGxvcFltUlZjWGZhMFo4dGVZNmNOMnJKZFpsRmxabEJhNSxCRG1DQ0FDQUVCWWRKaVFGYUZvY2tRUkFBOCIsCiAgICAgICAgICAic2l6ZXMiOiAiOTZ4OTYiCiAgICAgICAgfQogICAgICBdCiAgICB9CiAgXSwKICAic2hhcmVfdGFyZ2V0IjogewogICAgImFjdGlvbiI6ICIvP3NoYXJlLXRhcmdldCIsCiAgICAibWV0aG9kIjogIkdFVCIsCiAgICAiZW5jdHlwZSI6ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiLAogICAgInBhcmFtcyI6IHsKICAgICAgInRpdGxlIjogInRpdGxlIiwKICAgICAgInRleHQiOiAidGV4dCIsCiAgICAgICJ1cmwiOiAidXJsIgogICAgfQogIH0sCiAgInByb3RvY29sX2hhbmRsZXJzIjogWwogICAgewogICAgICAicHJvdG9jb2wiOiAid2ViK2R1aXplbmRlbiIsCiAgICAgICJ1cmwiOiAiLz91dG1fc291cmNlPXByb3RvY29sJmdhbWU9JXMiCiAgICB9CiAgXQp9">
    
    <!-- Enhanced Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+ICAgPHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSIyMCIgZmlsbD0iIzY2N2VlYSIvPiAgIDx0ZXh0IHg9IjkwIiB5PSI3MCIgY2xhc3M9ImJhc2UtbWlkZGxlIiBmaWxsPSIjRkZGRkYiIGZvbnQtZmFtaWx5PSItYXBwbGUtc3lzdGVtLEJsaW5rTWFjU3lzdGVtRm9udCwnU2VnVWkgVUkgR290aGljJyxSb2JvdG8sc2Fucy1zZXJpZiIgZm9udC1zaXplPSIzNnB4IiBmb250LXdlaWdodD0iNzAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCI+IPCfjoY8L3RleHQ+ICAgPHRleHQgeD0iOTAiIHk9IjExMCIgY2xhc3M9ImJhc2UtbWlkZGxlIiBmaWxsPSIjRkZGRkYiIGZvbnQtZmFtaWx5PSItYXBwbGUtc3lzdGVtLEJsaW5rTWFjU3lzdGVtRm9udCwnU2VnVWkgVUkgR290aGljJyxSb2JvdG8sc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNHB4IiBmb250LXdlaWdodD0iNjAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCI+RHVpemVuZGVuPC90ZXh0Pjwvc3ZnPg==">
    
    <!-- Additional icons for various devices -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4gIDxyZWN0IHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgcng9IjQiIGZpbGw9IiM2NjdlZWEiLz4gIDx0ZXh0IHg9IjE2IiB5PSIyMCIgY2xhc3M9ImJhc2UtbWlkZGxlIiBmaWxsPSIjRkZGRkYiIGZvbnQtZmFtaWx5PSItYXBwbGUtc3lzdGVtLEJsaW5rTWFjU3lzdGVtRm9udCwnU2VnVWkgVUkgR290aGljJyxSb2JvdG8sc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNHB4IiBmb250LXdlaWdodD0iNzAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCI+8J+OhzwvdGV4dD48L3N2Zz4=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            padding: 0;
            font-size: 16px;
            line-height: 1.5;
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: #0f172a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: env(safe-area-inset-top, 12px) 16px 16px 16px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 4px;
            font-weight: 800;
            letter-spacing: -0.025em;
        }

        .header p {
            font-size: 0.8rem;
            opacity: 0.8;
            font-weight: 500;
        }

        /* Mobile-first header actions */
        .header-actions {
            position: absolute;
            top: env(safe-area-inset-top, 12px);
            left: 16px;
            display: flex;
            gap: 8px;
            z-index: 101;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 10px;
            padding: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        .install-btn {
            position: absolute;
            top: env(safe-area-inset-top, 12px);
            right: 16px;
            background: rgba(139, 195, 74, 0.9);
            border: 1px solid rgba(139, 195, 74, 1);
            color: white;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            display: none;
            z-index: 101;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .install-btn.show {
            display: block;
            animation: pulse 2s infinite;
        }

        .install-btn:active {
            transform: scale(0.95);
        }

        .controls {
            padding: 20px 16px;
            background: #1e293b;
        }

        .player-input {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .player-input input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #334155;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: #0f172a;
            color: #f1f5f9;
            min-height: 48px;
            font-weight: 500;
        }

        .player-input input:focus {
            outline: none;
            border-color: #8bc34a;
            box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.1);
            background: #1e293b;
        }

        .player-input input::placeholder {
            color: #64748b;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: none;
            letter-spacing: 0;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8bc34a, #689f38);
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(139, 195, 74, 0.3);
            font-weight: 700;
        }

        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(139, 195, 74, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            width: 100%;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            margin-bottom: 12px;
        }

        .btn-danger:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            width: 100%;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .game-area {
            flex: 1;
            padding: 16px;
            overflow-x: hidden;
            background: #0f172a;
        }

        .players-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }

        .player-card {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            border: 1px solid #334155;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
        }

        .player-card:active {
            transform: scale(0.98);
        }

        .player-card.winner {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-color: #22c55e;
            animation: winner-pulse 2s infinite;
        }

        .player-card.close-to-win {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-color: #f59e0b;
        }

        .player-card.over-limit {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #ef4444;
        }

        @keyframes winner-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 8px 32px rgba(34, 197, 94, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 12px 40px rgba(34, 197, 94, 0.6); }
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .player-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            letter-spacing: -0.025em;
        }

        .player-total {
            font-size: 2rem;
            font-weight: 900;
            color: white;
            letter-spacing: -0.05em;
        }

        .remove-player {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .remove-player:active {
            transform: scale(0.9);
            background: rgba(220, 38, 38, 0.9);
        }

        .score-input-container {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        .score-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }

        .score-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 12px;
            width: 44px;
            height: 44px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .score-btn:active {
            transform: scale(0.9);
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .score-btn.minus {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .score-btn.minus:active {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .score-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #334155;
            border-radius: 12px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            max-width: 100px;
            background: #0f172a;
            color: white;
            min-height: 44px;
            transition: all 0.2s ease;
        }

        .score-input:focus {
            outline: none;
            border-color: #8bc34a;
            box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.1);
        }

        .quick-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .quick-score-btn {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-score-btn:active {
            transform: scale(0.95);
            background: rgba(37, 99, 235, 0.9);
        }

        .no-players {
            text-align: center;
            padding: 60px 24px;
            color: #64748b;
            font-size: 16px;
            line-height: 1.6;
            font-weight: 500;
        }

        .rounds-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 0 4px;
        }

        .rounds-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.025em;
        }

        .round-counter {
            background: linear-gradient(135deg, #8bc34a, #689f38);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(139, 195, 74, 0.3);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Status indicators */
        .status-indicator {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-winner {
            background: rgba(34, 197, 94, 0.9);
            color: white;
        }

        .status-close {
            background: rgba(245, 158, 11, 0.9);
            color: white;
        }

        .status-over {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }

        /* Accordion Styles - Mobile optimized */
        .round-accordion {
            margin-bottom: 8px;
        }

        .round-header-btn {
            width: 100%;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 48px;
        }

        .round-header-btn:active {
            transform: scale(0.98);
            background: rgba(51, 65, 85, 0.8);
        }

        .round-header-btn.expanded {
            background: rgba(51, 65, 85, 0.8);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
            border-color: #8bc34a;
        }

        .round-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .round-number {
            font-weight: 700;
            color: #8bc34a;
            font-size: 14px;
            min-width: 32px;
        }

        .round-score-display {
            font-weight: 700;
            color: white;
            font-size: 15px;
            padding: 4px 10px;
            border-radius: 8px;
            min-width: 48px;
            text-align: center;
        }

        .round-score-display.positive {
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .round-score-display.negative {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .round-score-display.zero {
            color: #64748b;
            background: rgba(100, 116, 139, 0.1);
        }

        .accordion-icon {
            font-size: 14px;
            transition: transform 0.2s ease;
            color: #64748b;
            min-width: 20px;
            text-align: center;
        }

        .accordion-icon.expanded {
            transform: rotate(180deg);
            color: #8bc34a;
        }

        .round-content {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 16px;
            display: none;
        }

        .round-content.expanded {
            display: block;
        }

        .current-round {
            border-left: 3px solid #8bc34a;
        }

        .current-round .round-header-btn {
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.2), rgba(104, 159, 56, 0.2));
            border-color: #8bc34a;
        }

        .current-round .round-number,
        .current-round .accordion-icon {
            color: #8bc34a;
        }

        .current-round .round-score-display {
            background: rgba(139, 195, 74, 0.2);
            color: white;
        }

        /* Enhanced notifications */
        .notification {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 20px);
            left: 16px;
            right: 16px;
            background: #1e293b;
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            border: 1px solid #334155;
            text-align: center;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.error {
            background: #ef4444;
            border-color: #ef4444;
        }

        .notification.warning {
            background: #f59e0b;
            color: #1e293b;
            border-color: #f59e0b;
        }

        .notification.success {
            background: #22c55e;
            border-color: #22c55e;
        }

        /* Mobile-optimized Table View */
        .table-view {
            overflow-x: auto;
            margin: 16px 0;
            border-radius: 12px;
            background: #1e293b;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .scores-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 100%;
        }

        .scores-table th {
            background: linear-gradient(135deg, #8bc34a, #689f38);
            color: white;
            padding: 12px 8px;
            font-weight: 700;
            text-align: center;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scores-table th:first-child {
            border-top-left-radius: 12px;
        }

        .scores-table th:last-child {
            border-top-right-radius: 12px;
        }

        .scores-table td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid #334155;
            font-size: 13px;
            color: white;
            position: relative;
            font-weight: 600;
        }

        .scores-table tr:hover {
            background-color: rgba(139, 195, 74, 0.05);
        }

        .round-cell {
            background: #334155;
            font-weight: 700;
            color: white;
            min-width: 40px;
            font-size: 12px;
        }

        .score-cell {
            min-width: 60px;
        }

        .total-row {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        .total-row td {
            border-bottom: none;
            padding: 12px 6px;
        }

        .running-total {
            font-size: 0.7rem;
            color: #94a3b8;
            display: block;
            margin-top: 2px;
            font-weight: 400;
        }

        .score-with-total {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .round-score {
            font-weight: 700;
            color: white;
        }

        /* Leader indicators - More mobile friendly */
        .leader-1 {
            background: linear-gradient(135deg, #22c55e, #16a34a) !important;
            color: white !important;
            position: relative;
        }

        .leader-1::after {
            content: "ü•á";
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
        }

        .leader-2 {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            color: white !important;
            position: relative;
        }

        .leader-2::after {
            content: "ü•à";
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
        }

        .leader-3 {
            background: linear-gradient(135deg, #a855f7, #9333ea) !important;
            color: white !important;
            position: relative;
        }

        .leader-3::after {
            content: "ü•â";
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
        }

        .winner-total {
            background: linear-gradient(135deg, #22c55e, #16a34a) !important;
            color: white !important;
            animation: winner-pulse 2s infinite;
            font-size: 1.1rem !important;
        }

        .close-total {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            color: white !important;
        }

        .over-total {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            color: white !important;
        }

        /* Enhanced offline indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f59e0b;
            color: white;
            text-align: center;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);
        }

        .offline-indicator.show {
            transform: translateY(0);
        }

        /* Winner celebration - Mobile optimized */
        .winner-celebration {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
            padding: 20px;
        }

        .winner-modal {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-radius: 20px;
            padding: 32px 24px;
            text-align: center;
            color: white;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: winner-bounce 0.6s ease;
            max-width: 100%;
            width: 100%;
            max-width: 320px;
        }

        .winner-modal h2 {
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 900;
            letter-spacing: -0.025em;
        }

        .winner-modal p {
            font-size: 1.1rem;
            margin-bottom: 16px;
            font-weight: 600;
            opacity: 0.95;
        }

        .winner-modal .btn {
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.9);
            color: #16a34a;
            font-weight: 700;
            width: 100%;
        }

        @keyframes winner-bounce {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* Share modal - Mobile optimized */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
            padding: 0;
        }

        .share-modal-content {
            background: #1e293b;
            border-radius: 20px 20px 0 0;
            padding: 24px 20px env(safe-area-inset-bottom, 20px) 20px;
            color: white;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #334155;
            border-bottom: none;
        }

        .share-modal h3 {
            font-size: 1.3rem;
            margin-bottom: 16px;
            color: #8bc34a;
            font-weight: 700;
            text-align: center;
        }

        .share-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .share-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
        }

        .share-btn:active {
            background: #2563eb;
            transform: scale(0.95);
        }

        .share-text {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            font-family: ui-monospace, SFMono-Regular, 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.85rem;
            margin: 16px 0;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            color: #e2e8f0;
            line-height: 1.5;
        }

        /* Enhanced keyboard shortcuts styling */
        kbd {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 2px 6px;
            font-family: ui-monospace, SFMono-Regular, 'SF Mono', Consolas, monospace;
            font-size: 0.8em;
            color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            font-weight: 600;
        }

        /* Large screen optimizations */
        @media (min-width: 768px) {
            .container {
                max-width: 420px;
                margin: 0 auto;
                border-radius: 0;
                overflow: hidden;
                min-height: 100vh;
            }

            .players-grid {
                gap: 20px;
            }

            .game-area {
                padding: 20px;
            }

            .controls {
                padding: 20px;
            }

            .player-input {
                flex-direction: row;
                gap: 12px;
            }

            .btn-primary {
                width: auto;
                flex-shrink: 0;
            }

            .header-actions {
                position: absolute;
                top: env(safe-area-inset-top, 12px);
                left: 16px;
            }

            .install-btn {
                position: absolute;
                top: env(safe-area-inset-top, 12px);
                right: 16px;
            }

            .quick-scores {
                grid-template-columns: repeat(6, 1fr);
                gap: 10px;
            }

            .share-modal {
                align-items: center;
            }

            .share-modal-content {
                border-radius: 20px;
                width: auto;
                max-width: 400px;
                margin: 20px;
            }
        }

        /* Extra large screens - keep mobile-like experience */
        @media (min-width: 1024px) {
            .container {
                max-width: 420px;
            }
        }

        /* Performance indicator for debugging */
        .performance-indicator {
            position: fixed;
            top: env(safe-area-inset-top, 60px);
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #8bc34a;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-family: ui-monospace, SFMono-Regular, 'SF Mono', Consolas, monospace;
            z-index: 999;
            display: none;
            border: 1px solid #334155;
        }

        /* Improved focus states for accessibility */
        .btn:focus-visible,
        .score-btn:focus-visible,
        .quick-score-btn:focus-visible,
        .remove-player:focus-visible,
        .round-header-btn:focus-visible,
        .header-btn:focus-visible,
        .share-btn:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        .player-input input:focus-visible,
        .score-input:focus-visible {
            outline: 3px solid #4ecdc4;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .player-card {
                border: 2px solid #ffffff;
            }
            
            .score-input-container {
                border: 2px solid #ffffff;
            }
            
            .btn, .score-btn, .quick-score-btn, .header-btn, .share-btn {
                border: 2px solid #ffffff;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .btn, .score-btn, .quick-score-btn, .remove-player, 
            .round-header-btn, .accordion-icon, .header-btn,
            .share-btn, .player-card {
                transition: none;
            }
            
            .winner, .winner-pulse {
                animation: none;
            }

            .install-btn.show {
                animation: none;
            }
        }

        /* Loading states */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            100% { left: 100%; }
        }
    </style>
</head>
<body>
    <div id="offlineIndicator" class="offline-indicator">
        ‚úàÔ∏è Offline modus - alle functies beschikbaar! Scores worden lokaal opgeslagen.
    </div>

    <div id="performanceIndicator" class="performance-indicator"></div>

    <div class="container">
        <div class="header">
            <div class="header-actions">
                <button class="header-btn" onclick="shareGame()" title="Deel scores">üì§</button>
                <button class="header-btn" onclick="showKeyboardShortcuts()" title="Help & Sneltoetsen">‚ùì</button>
                <button class="header-btn" onclick="toggleWakeLock()" title="Scherm aan houden" id="wakeLockBtn">üîÜ</button>
            </div>
            <button id="installBtn" class="install-btn">
                üì≤ Installeer App
            </button>
            <h1>üéØ Duizenden</h1>
            <p>Eerste speler die 1000+ punten behaalt wint! ‚Ä¢ Werkt volledig offline</p>
        </div>

        <div class="controls">
            <div class="player-input">
                <input type="text" id="playerName" placeholder="Speler naam..." maxlength="20" autocomplete="off">
                <button class="btn btn-primary" onclick="addPlayer()">Toevoegen</button>
            </div>
            <button class="btn btn-danger" onclick="resetGame()">üóëÔ∏è Nieuw Spel</button>
            <button class="btn btn-secondary" id="viewToggle" onclick="toggleView()">üìä Tabel Weergave</button>
        </div>

        <div class="game-area">
            <div id="gameContent">
                <div class="no-players">
                    üëÜ Voeg spelers toe om te beginnen!
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="share-modal" style="display: none;" onclick="closeShareModal()">
        <div class="share-modal-content" onclick="event.stopPropagation()">
            <h3>üì§ Deel Scores</h3>
            <div class="share-text" id="shareText"></div>
            <div class="share-buttons">
                <button class="share-btn" onclick="copyShareText()">üìã Kopi√´ren</button>
                <button class="share-btn" onclick="shareViaWebAPI()">üì± Delen</button>
                <button class="share-btn" onclick="shareViaWhatsApp()">üí¨ WhatsApp</button>
                <button class="share-btn" onclick="shareViaEmail()">üìß Email</button>
            </div>
            <button class="btn" onclick="closeShareModal()" style="width: 100%; margin-top: 20px;">Sluiten</button>
        </div>
    </div>

    <script>
        // Global variables
        let players = [];
        let rounds = [];
        let currentView = 'cards';
        let deferredPrompt;
        let wakeLock = null;
        let isOnline = navigator.onLine;
        let performanceObserver;

        // Enhanced shake detection with adjustable sensitivity
        class ShakeDetector {
            constructor() {
                this.threshold = 8; // Lowered sensitivity threshold (was 15)
                this.timeout = 1000; // Debounce timeout
                this.lastTime = 0;
                this.lastX = 0;
                this.lastY = 0;
                this.lastZ = 0;
                this.shakeEnabled = false;
                this.lastShake = 0;
                this.permissionStatus = 'unknown'; // 'unknown', 'granted', 'denied', 'not-required'
                this.debugInfo = {};
                this.testMode = false; // For sensitivity testing
            }

            async init() {
                console.log('üîç Initializing shake detection...');
                
                // Comprehensive environment debugging
                this.debugInfo = {
                    userAgent: navigator.userAgent,
                    isHTTPS: location.protocol === 'https:',
                    isLocalhost: location.hostname === 'localhost',
                    hasDeviceMotionEvent: !!window.DeviceMotionEvent,
                    hasRequestPermission: typeof DeviceMotionEvent?.requestPermission === 'function',
                    platform: navigator.platform,
                    touchSupport: 'ontouchstart' in window
                };
                
                console.log('üìä Debug info:', this.debugInfo);
                
                // Check if device motion is available
                if (!window.DeviceMotionEvent) {
                    console.log('‚ùå DeviceMotionEvent not available');
                    showNotification('‚ùå Dit apparaat ondersteunt geen bewegingsdetectie', 'error');
                    return false;
                }

                // Check HTTPS requirement for Android
                if (!this.debugInfo.isHTTPS && !this.debugInfo.isLocalhost) {
                    console.log('‚ùå HTTPS required for DeviceMotionEvent');
                    showNotification('üîí HTTPS vereist voor shake detectie', 'warning');
                    return false;
                }

                // Test if DeviceMotionEvent actually works
                const testResult = await this.testDeviceMotionSupport();
                if (!testResult) {
                    return false;
                }

                // Handle permission based on platform
                if (this.debugInfo.hasRequestPermission) {
                    console.log('üì± iOS device detected - requesting permission...');
                    return await this.requestIOSPermission();
                } else {
                    console.log('ü§ñ Android/other device detected - enabling directly...');
                    this.permissionStatus = 'not-required';
                    this.enable();
                    return true;
                }
            }

            async testDeviceMotionSupport() {
                console.log('üß™ Testing DeviceMotionEvent support...');
                
                return new Promise((resolve) => {
                    let eventReceived = false;
                    let testTimeout;
                    
                    const testHandler = (event) => {
                        console.log('‚úÖ DeviceMotionEvent working! Sample data:', {
                            x: event.accelerationIncludingGravity?.x,
                            y: event.accelerationIncludingGravity?.y,
                            z: event.accelerationIncludingGravity?.z
                        });
                        
                        eventReceived = true;
                        window.removeEventListener('devicemotion', testHandler);
                        clearTimeout(testTimeout);
                        resolve(true);
                    };
                    
                    // Add test listener
                    window.addEventListener('devicemotion', testHandler, { passive: true });
                    
                    // Give it 3 seconds to fire an event
                    testTimeout = setTimeout(() => {
                        window.removeEventListener('devicemotion', testHandler);
                        
                        if (!eventReceived) {
                            console.log('‚ùå No DeviceMotionEvent received after 3 seconds');
                            
                            // Provide specific guidance based on platform
                            let errorMsg = '‚ùå Geen bewegingsdata ontvangen';
                            if (this.debugInfo.userAgent.includes('Samsung')) {
                                errorMsg += ' - Samsung apparaat mogelijk geen gyroscoop';
                            } else if (!this.debugInfo.isHTTPS && !this.debugInfo.isLocalhost) {
                                errorMsg += ' - HTTPS vereist';
                            } else {
                                errorMsg += ' - controleer browser permissies';
                            }
                            
                            showNotification(errorMsg, 'error');
                            resolve(false);
                        }
                    }, 3000);
                });
            }

            async requestIOSPermission() {
                try {
                    console.log('üîê Requesting iOS motion permission...');
                    const permission = await DeviceMotionEvent.requestPermission();
                    console.log('üìã Permission result:', permission);
                    
                    if (permission === 'granted') {
                        this.permissionStatus = 'granted';
                        this.enable();
                        showNotification('üéâ Shake detectie ingeschakeld!');
                        return true;
                    } else {
                        this.permissionStatus = 'denied';
                        showNotification('Shake detectie geweigerd. Herstart Safari om opnieuw te proberen.', 'warning');
                        console.log('‚ùå Permission denied by user');
                        return false;
                    }
                } catch (error) {
                    console.error('üí• Permission request failed:', error);
                    this.permissionStatus = 'denied';
                    
                    if (error.name === 'NotAllowedError') {
                        showNotification('Shake detectie moet vanuit gebruikersactie worden geactiveerd', 'warning');
                    } else {
                        showNotification('Fout bij aanvragen shake permissie', 'error');
                    }
                    return false;
                }
            }

            enable() {
                if (this.permissionStatus === 'denied') {
                    console.log('‚ùå Cannot enable - permission denied');
                    return;
                }

                this.shakeEnabled = true;
                console.log('‚úÖ Adding device motion listener...');
                window.addEventListener('devicemotion', this.handleMotion.bind(this), { passive: true });
                
                // Enhanced test to confirm events are firing
                setTimeout(() => {
                    if (this.lastTime === 0) {
                        console.log('‚ö†Ô∏è Device motion events not firing after enable');
                        console.log('üîç Debug info:', this.debugInfo);
                        
                        let troubleshootMsg = 'Geen bewegingsdata - ';
                        if (this.debugInfo.userAgent.includes('Samsung')) {
                            troubleshootMsg += 'mogelijk geen sensoren beschikbaar';
                        } else if (this.debugInfo.userAgent.includes('Chrome')) {
                            troubleshootMsg += 'controleer Chrome instellingen > Privacy > Sensoren';
                        } else {
                            troubleshootMsg += 'herlaad pagina of controleer browser instellingen';
                        }
                        
                        showNotification(troubleshootMsg, 'warning');
                    } else {
                        console.log('üì° Device motion events working!');
                        showNotification('üì± Shake detectie actief - schud je telefoon!');
                    }
                }, 2000);
            }

            disable() {
                this.shakeEnabled = false;
                console.log('üõë Removing device motion listener...');
                window.removeEventListener('devicemotion', this.handleMotion.bind(this));
            }

            handleMotion(event) {
                if (!this.shakeEnabled || !event.accelerationIncludingGravity) {
                    return;
                }

                const now = Date.now();
                if (now - this.lastShake < this.timeout) return;

                const { x, y, z } = event.accelerationIncludingGravity;
                
                // Log first event to confirm it's working
                if (this.lastTime === 0) {
                    console.log('üìä First motion event received:', { x, y, z });
                }
                
                if (this.lastTime) {
                    const deltaTime = now - this.lastTime;
                    
                    if (deltaTime > 100) { // Minimum time between samples
                        const deltaX = Math.abs(x - this.lastX);
                        const deltaY = Math.abs(y - this.lastY);
                        const deltaZ = Math.abs(z - this.lastZ);
                        
                        // Calculate total acceleration change
                        const acceleration = deltaX + deltaY + deltaZ;
                        
                        // In test mode, show current acceleration values
                        if (this.testMode) {
                            console.log(`üìä Acceleration: ${acceleration.toFixed(1)} (threshold: ${this.threshold})`);
                            // Show visual feedback for testing
                            if (acceleration > this.threshold * 0.7) {
                                showNotification(`üî• Bijna! ${acceleration.toFixed(1)}/${this.threshold}`, 'warning');
                            }
                        }
                        
                        // Log high acceleration events for debugging
                        if (acceleration > this.threshold * 0.8) {
                            console.log('üî• High acceleration detected:', acceleration.toFixed(1), 'threshold:', this.threshold);
                        }
                        
                        if (acceleration > this.threshold) {
                            console.log('üí• SHAKE DETECTED! Acceleration:', acceleration.toFixed(1));
                            this.onShake();
                            this.lastShake = now;
                        }
                    }
                }

                this.lastTime = now;
                this.lastX = x;
                this.lastY = y;
                this.lastZ = z;
            }

            onShake() {
                // In test mode, don't toggle view, just show feedback
                if (this.testMode) {
                    showNotification('‚úÖ SHAKE GEDETECTEERD! Perfect!', 'success');
                    this.vibrate();
                    return;
                }

                // Only toggle if there are players (avoid confusion)
                if (players.length === 0) {
                    showNotification('Voeg eerst spelers toe!', 'warning');
                    return;
                }

                console.log('üéØ Shake detected - toggling view');

                // Haptic feedback
                this.vibrate();
                
                // Toggle view
                toggleView();
                
                // Show feedback
                const viewName = currentView === 'table' ? 'Tabel' : 'Kaart';
                showNotification(`üì± ${viewName} weergave geactiveerd!`);
            }

            vibrate() {
                if ('vibrate' in navigator) {
                    navigator.vibrate([50, 50, 50]); // Triple short vibration
                }
            }

            // Public method to check if shake detection is available
            isAvailable() {
                return window.DeviceMotionEvent && 
                       (location.protocol === 'https:' || location.hostname === 'localhost');
            }

            // Public method to get current status
            getStatus() {
                return {
                    available: this.isAvailable(),
                    enabled: this.shakeEnabled,
                    permission: this.permissionStatus,
                    debugInfo: this.debugInfo,
                    sensitivity: this.threshold,
                    testMode: this.testMode
                };
            }

            // Sensitivity adjustment methods
            setSensitivity(newThreshold) {
                this.threshold = Math.max(2, Math.min(25, newThreshold)); // Clamp between 2-25
                console.log(`üéõÔ∏è Sensitivity set to: ${this.threshold}`);
                localStorage.setItem('duizenden_shake_sensitivity', this.threshold.toString());
                return this.threshold;
            }

            increaseSensitivity() {
                const newThreshold = this.setSensitivity(this.threshold - 2); // Lower number = more sensitive
                showNotification(`Gevoeligheid verhoogd: ${newThreshold}`, 'success');
                return newThreshold;
            }

            decreaseSensitivity() {
                const newThreshold = this.setSensitivity(this.threshold + 2); // Higher number = less sensitive
                showNotification(`Gevoeligheid verlaagd: ${newThreshold}`, 'warning');
                return newThreshold;
            }

            // Test mode for calibrating shake intensity
            startTestMode() {
                if (!this.shakeEnabled) {
                    showNotification('Schakel eerst shake detectie in (M)', 'warning');
                    return false;
                }

                this.testMode = true;
                console.log('üß™ Test mode started - shake your phone to see values');
                showNotification('üß™ Test modus - schud je telefoon om waarden te zien!', 'success');
                
                // Auto-stop test mode after 10 seconds
                setTimeout(() => {
                    if (this.testMode) {
                        this.stopTestMode();
                    }
                }, 10000);
                
                return true;
            }

            stopTestMode() {
                this.testMode = false;
                console.log('üõë Test mode stopped');
                showNotification('Test modus gestopt', 'success');
            }

            // Load saved sensitivity
            loadSensitivity() {
                const saved = localStorage.getItem('duizenden_shake_sensitivity');
                if (saved) {
                    this.threshold = parseInt(saved);
                    console.log(`üì± Loaded saved sensitivity: ${this.threshold}`);
                }
            }

            // Enhanced debugging method
            async runDiagnostics() {
                console.log('üî¨ Running shake detection diagnostics...');
                
                const diagnostics = {
                    environment: this.debugInfo,
                    deviceMotionAvailable: !!window.DeviceMotionEvent,
                    httpsCheck: location.protocol === 'https:' || location.hostname === 'localhost',
                    permissionAPI: typeof DeviceMotionEvent?.requestPermission === 'function',
                    currentStatus: this.getStatus()
                };
                
                // Test if events fire
                if (window.DeviceMotionEvent) {
                    const eventTest = await this.testDeviceMotionSupport();
                    diagnostics.eventTest = eventTest;
                }
                
                console.log('üìã Diagnostics complete:', diagnostics);
                return diagnostics;
            }
        }

        // Initialize shake detector
        let shakeDetector;

        // Enhanced PWA features
        class DuizendenPWA {
            constructor() {
                this.initServiceWorker();
                this.initInstallPrompt();
                this.initOfflineHandling();
                this.initPerformanceMonitoring();
                this.initAppShortcuts();
                this.initShakeDetection();
                this.handleUrlParams();
            }

            async initShakeDetection() {
                // Initialize shake detector but don't auto-enable
                if (this.isMobileDevice()) {
                    shakeDetector = new ShakeDetector();
                    
                    // Load saved sensitivity
                    shakeDetector.loadSensitivity();
                    
                    // Check if shake detection is available
                    if (shakeDetector.isAvailable()) {
                        console.log('üì± Shake detection available');
                        
                        // For iOS devices, show a help message about manual activation
                        if (typeof DeviceMotionEvent.requestPermission === 'function') {
                            setTimeout(() => {
                                if (!localStorage.getItem('duizenden_shake_help_shown')) {
                                    showNotification('üí° Tip: Gebruik de help knop (‚ùì) om shake detectie in te schakelen!');
                                    localStorage.setItem('duizenden_shake_help_shown', 'true');
                                }
                            }, 8000);
                        } else {
                            // For Android, auto-enable since no permission needed
                            setTimeout(async () => {
                                const success = await shakeDetector.init();
                                if (success) {
                                    showNotification('üì± Schud je telefoon lichtjes om tussen weergaves te wisselen!');
                                }
                            }, 3000);
                        }
                    } else {
                        console.log('‚ùå Shake detection not available (needs HTTPS)');
                    }
                }
            }

            isMobileDevice() {
                return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                       (window.innerWidth <= 768 && 'ontouchstart' in window);
            }

            async initServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register(this.generateOfflineServiceWorker());
                        console.log('Offline-first SW registered successfully');
                        
                        // Handle service worker updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showNotification('App update beschikbaar - herstart de app!', 'warning');
                                }
                            });
                        });
                    } catch (error) {
                        console.log('SW registration failed:', error);
                        // App still works without service worker
                        showNotification('App werkt volledig offline!', 'success');
                    }
                }
            }

            generateOfflineServiceWorker() {
                const swCode = `
                    const CACHE_NAME = 'duizenden-offline-v3.0';
                    const STATIC_CACHE = 'duizenden-static-v3.0';
                    
                    // Complete offline-first strategy
                    const OFFLINE_FALLBACK = 'data:text/html;charset=utf-8,<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Duizenden - Offline</title><style>body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#e0e6ed;padding:40px;text-align:center;min-height:100vh;display:flex;flex-direction:column;justify-content:center;}h1{color:#4ecdc4;margin-bottom:20px;}p{margin:10px 0;}</style></head><body><h1>üéØ Duizenden</h1><h2>Volledig Offline Beschikbaar!</h2><p>Deze app werkt 100% zonder internetverbinding.</p><p>Je kunt nu:</p><ul style="text-align:left;max-width:300px;margin:20px auto;"><li>Spelers toevoegen</li><li>Scores bijhouden</li><li>Spelresultaten delen</li><li>App installeren</li></ul><p><a href="." style="color:#4ecdc4;text-decoration:none;background:#667eea;padding:12px 24px;border-radius:8px;display:inline-block;margin-top:20px;">üéÆ Start Duizenden</a></p></body></html>';

                    // Install event - cache everything we need for offline use
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(STATIC_CACHE)
                                .then(cache => {
                                    // Cache the main app and offline fallback
                                    return cache.addAll([
                                        './',
                                        './?source=pwa',
                                        OFFLINE_FALLBACK
                                    ]);
                                })
                        );
                        self.skipWaiting();
                    });

                    // Activate event - clean up old caches
                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== STATIC_CACHE && cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                        self.clients.claim();
                    });

                    // Fetch event - offline-first strategy
                    self.addEventListener('fetch', event => {
                        // Only handle GET requests
                        if (event.request.method !== 'GET') return;
                        
                        // Skip cross-origin requests
                        if (!event.request.url.startsWith(self.location.origin)) return;

                        event.respondWith(
                            // Try cache first
                            caches.match(event.request)
                                .then(cachedResponse => {
                                    if (cachedResponse) {
                                        return cachedResponse;
                                    }
                                    
                                    // If not in cache and online, try to fetch
                                    return fetch(event.request)
                                        .then(response => {
                                            // Check if valid response
                                            if (!response || response.status !== 200 || response.type !== 'basic') {
                                                return response;
                                            }
                                            
                                            // Clone and cache the response
                                            const responseToCache = response.clone();
                                            caches.open(CACHE_NAME)
                                                .then(cache => {
                                                    cache.put(event.request, responseToCache);
                                                });
                                            
                                            return response;
                                        })
                                        .catch(() => {
                                            // Network failed, return offline fallback for HTML requests
                                            if (event.request.headers.get('accept').includes('text/html')) {
                                                return caches.match(OFFLINE_FALLBACK);
                                            }
                                            // For other requests, return a generic offline response
                                            return new Response('Offline', { status: 503, statusText: 'Service Unavailable' });
                                        });
                                })
                        );
                    });

                    // Background sync for when connection returns
                    self.addEventListener('sync', event => {
                        if (event.tag === 'duizenden-sync') {
                            event.waitUntil(
                                // Sync any pending game data
                                self.clients.matchAll().then(clients => {
                                    clients.forEach(client => {
                                        client.postMessage({ type: 'SYNC_DATA' });
                                    });
                                })
                            );
                        }
                    });

                    // Handle messages from main thread
                    self.addEventListener('message', event => {
                        if (event.data && event.data.command === 'SKIP_WAITING') {
                            self.skipWaiting();
                        }
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                return URL.createObjectURL(blob);
            }

            initInstallPrompt() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    document.getElementById('installBtn').classList.add('show');
                });

                document.getElementById('installBtn').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            document.getElementById('installBtn').classList.remove('show');
                            showNotification('App succesvol ge√Ønstalleerd! üéâ');
                        }
                        deferredPrompt = null;
                    }
                });

                // Handle app installed
                window.addEventListener('appinstalled', () => {
                    showNotification('Duizenden app ge√Ønstalleerd! üéâ');
                    document.getElementById('installBtn').classList.remove('show');
                });
            }

            initOfflineHandling() {
                const updateOnlineStatus = () => {
                    const wasOnline = isOnline;
                    isOnline = navigator.onLine;
                    const indicator = document.getElementById('offlineIndicator');
                    
                    if (isOnline && !wasOnline) {
                        indicator.classList.remove('show');
                        this.syncPendingData();
                        showNotification('Verbinding hersteld! üì∂');
                    } else if (!isOnline && wasOnline) {
                        indicator.classList.add('show');
                        showNotification('Offline modus - app blijft volledig werken! üî•');
                    }
                };

                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);

                // Check initial state and show offline capability message
                if (!isOnline) {
                    document.getElementById('offlineIndicator').classList.add('show');
                } else {
                    // Show that app can work offline
                    setTimeout(() => {
                        showNotification('üí° App werkt volledig offline - installeer voor beste ervaring!');
                    }, 3000);
                }
            }

            async syncPendingData() {
                // Enhanced background sync
                if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                    try {
                        const registration = await navigator.serviceWorker.ready;
                        await registration.sync.register('duizenden-sync');
                    } catch (e) {
                        console.log('Background sync not available');
                    }
                }
                
                // Immediate sync
                saveGame();
                console.log('Data synced - app fully functional offline');
            }

            initPerformanceMonitoring() {
                if ('PerformanceObserver' in window) {
                    performanceObserver = new PerformanceObserver((list) => {
                        for (const entry of list.getEntries()) {
                            if (entry.entryType === 'measure') {
                                const indicator = document.getElementById('performanceIndicator');
                                indicator.textContent = `${entry.name}: ${Math.round(entry.duration)}ms`;
                                indicator.style.display = 'block';
                                setTimeout(() => {
                                    indicator.style.display = 'none';
                                }, 2000);
                            }
                        }
                    });
                    performanceObserver.observe({ entryTypes: ['measure'] });
                }
            }

            initAppShortcuts() {
                // Handle app shortcuts from manifest
                const urlParams = new URLSearchParams(window.location.search);
                const action = urlParams.get('action');
                
                if (action === 'new_game') {
                    resetGame();
                    showNotification('Nieuw spel gestart! üéØ');
                } else if (action === 'share') {
                    setTimeout(() => shareGame(), 1000);
                }
            }

            handleUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const gameData = urlParams.get('game');
                
                if (gameData) {
                    try {
                        const decoded = JSON.parse(atob(gameData));
                        if (decoded.players && decoded.rounds) {
                            players = decoded.players;
                            rounds = decoded.rounds;
                            updateDisplay();
                            showNotification('Spel geladen van link! üîó');
                        }
                    } catch (e) {
                        console.log('Failed to load game from URL:', e);
                    }
                }
            }
        }

        // Enhanced notifications system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);

            // Vibration feedback if supported
            if ('vibrator' in navigator || 'vibrate' in navigator) {
                navigator.vibrate([50]);
            }
        }

        // Enhanced Wake Lock API
        async function toggleWakeLock() {
            const btn = document.getElementById('wakeLockBtn');
            
            try {
                if (wakeLock === null && 'wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    btn.textContent = 'üîÖ';
                    btn.title = 'Scherm uit laten gaan';
                    showNotification('Scherm blijft aan tijdens het spel');
                    
                    wakeLock.addEventListener('release', () => {
                        btn.textContent = 'üîÜ';
                        btn.title = 'Scherm aan houden';
                        wakeLock = null;
                    });
                } else if (wakeLock !== null) {
                    await wakeLock.release();
                    wakeLock = null;
                    btn.textContent = 'üîÜ';
                    btn.title = 'Scherm aan houden';
                    showNotification('Scherm kan nu uitgaan');
                }
            } catch (err) {
                showNotification('Wake lock niet ondersteund', 'warning');
            }
        }

        // Enhanced offline-first sharing functionality
        function generateShareText() {
            if (players.length === 0) return 'Nog geen spelers toegevoegd';
            
            const ranking = getLeaderRanking();
            let text = `üéØ Duizenden Scorebord (Offline)\n\n`;
            
            ranking.forEach((player, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '  ';
                text += `${medal} ${player.name}: ${player.total} punten\n`;
            });
            
            text += `\nRonde: ${rounds.length}\n`;
            text += `Datum: ${new Date().toLocaleDateString('nl-NL')}\n`;
            text += `\nüéÆ Duizenden - De kaartspel score app\n(Werkt volledig offline!)`;
            
            return text;
        }

        function shareGame() {
            document.getElementById('shareText').textContent = generateShareText();
            document.getElementById('shareModal').style.display = 'flex';
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        async function copyShareText() {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(generateShareText());
                    showNotification('Gekopieerd naar klembord! üìã');
                } else {
                    // Fallback for older browsers or when clipboard API is not available
                    const textArea = document.createElement('textarea');
                    textArea.value = generateShareText();
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        showNotification('Gekopieerd naar klembord! üìã');
                    } catch (err) {
                        showNotification('Kopi√´ren mislukt - probeer handmatig selecteren', 'warning');
                    } finally {
                        document.body.removeChild(textArea);
                    }
                }
                closeShareModal();
            } catch (err) {
                showNotification('Kopi√´ren mislukt', 'error');
            }
        }

        async function shareViaWebAPI() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Duizenden Scores',
                        text: generateShareText()
                    });
                    closeShareModal();
                    showNotification('Scores gedeeld! üì§');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        showNotification('Delen mislukt', 'error');
                    }
                }
            } else {
                // Fallback: copy to clipboard
                await copyShareText();
            }
        }

        function shareViaWhatsApp() {
            const text = encodeURIComponent(generateShareText());
            const whatsappUrl = `whatsapp://send?text=${text}`;
            
            // Try to open WhatsApp app, fallback to web version
            try {
                window.open(whatsappUrl, '_blank');
                closeShareModal();
            } catch (e) {
                // Fallback to web WhatsApp (works offline for installed WhatsApp)
                const webWhatsApp = `https://wa.me/?text=${text}`;
                window.open(webWhatsApp, '_blank');
                closeShareModal();
            }
        }

        function shareViaEmail() {
            const subject = encodeURIComponent('Duizenden Scores');
            const body = encodeURIComponent(generateShareText());
            const emailUrl = `mailto:?subject=${subject}&body=${body}`;
            
            try {
                window.open(emailUrl, '_blank');
                closeShareModal();
            } catch (e) {
                showNotification('Email app niet gevonden', 'warning');
                // Fallback to copying text
                copyShareText();
            }
        }

        // Enhanced game data management
        function saveGame() {
            performance.mark('save-start');
            
            try {
                const gameData = {
                    players: players,
                    rounds: rounds,
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                };
                
                localStorage.setItem('duizenden_game', JSON.stringify(gameData));
                
                // Also save backup
                const backupKey = `duizenden_backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(gameData));
                
                // Clean old backups (keep last 5)
                const allKeys = Object.keys(localStorage).filter(key => key.startsWith('duizenden_backup_'));
                if (allKeys.length > 5) {
                    allKeys.sort().slice(0, -5).forEach(key => localStorage.removeItem(key));
                }
                
                checkForWinner();
                
                performance.mark('save-end');
                performance.measure('save-duration', 'save-start', 'save-end');
                
            } catch (e) {
                showNotification('Opslaan mislukt', 'error');
                console.log('Save error:', e);
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('duizenden_game');
                if (saved) {
                    const gameData = JSON.parse(saved);
                    players = gameData.players || [];
                    rounds = gameData.rounds || [];
                    updateDisplay();
                    
                    if (players.length > 0) {
                        showNotification('Vorig spel geladen! üéÆ');
                    }
                }
            } catch (e) {
                showNotification('Laden mislukt', 'error');
                console.log('Load error:', e);
            }
        }

        // Enhanced winner detection
        function checkForWinner() {
            if (rounds.length === 0) return;

            const playersWithScores = players.map(player => ({
                name: player,
                total: getPlayerTotal(player)
            }));

            const winners = playersWithScores.filter(p => p.total >= 1000);
            
            if (winners.length > 0) {
                let actualWinner;
                if (winners.length === 1) {
                    actualWinner = winners[0];
                } else {
                    actualWinner = winners.reduce((closest, current) => {
                        const closestDistance = Math.abs(1000 - closest.total);
                        const currentDistance = Math.abs(1000 - current.total);
                        return currentDistance < closestDistance ? current : closest;
                    });
                }
                
                setTimeout(() => showWinnerCelebration(actualWinner.name, actualWinner.total), 500);
            }
        }

        function showWinnerCelebration(winnerName, score) {
            const celebrationHtml = `
                <div class="winner-celebration" onclick="closeWinnerModal()">
                    <div class="winner-modal" onclick="event.stopPropagation()">
                        <h2>üéâ WINNAAR! üéâ</h2>
                        <p><strong>${winnerName}</strong></p>
                        <p>heeft gewonnen met ${score} punten!</p>
                        <button class="btn" onclick="shareGame()">üì§ Deel Resultaat</button>
                        <button class="btn" onclick="closeWinnerModal()">Doorgaan</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', celebrationHtml);
            
            // Confetti effect
            if ('vibrator' in navigator || 'vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }

        function closeWinnerModal() {
            const modal = document.querySelector('.winner-celebration');
            if (modal) {
                modal.remove();
            }
        }

        // Core game functions (enhanced)
        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (name === '') {
                showNotification('Voer een speler naam in!', 'warning');
                nameInput.focus();
                return;
            }
            
            if (players.includes(name)) {
                showNotification('Deze speler bestaat al!', 'warning');
                nameInput.focus();
                return;
            }
            
            if (players.length >= 8) {
                showNotification('Maximum 8 spelers toegestaan!', 'warning');
                return;
            }
            
            players.push(name);
            nameInput.value = '';
            
            rounds.forEach(round => {
                if (!round.hasOwnProperty(name)) {
                    round[name] = 0;
                }
            });
            
            updateDisplay();
            saveGame();
            showNotification(`${name} toegevoegd! üëç`);
        }

        function removePlayer(playerName) {
            if (confirm(`Weet je zeker dat je ${playerName} wilt verwijderen?`)) {
                const index = players.indexOf(playerName);
                if (index > -1) {
                    players.splice(index, 1);
                    rounds.forEach(round => {
                        delete round[playerName];
                    });
                    updateDisplay();
                    saveGame();
                    showNotification(`${playerName} verwijderd`);
                }
            }
        }

        function addRound() {
            const newRound = {};
            players.forEach(player => {
                newRound[player] = 0;
            });
            rounds.push(newRound);
            updateDisplay();
            saveGame();
            showNotification(`Ronde ${rounds.length} gestart! üéØ`);
        }

        function updateScore(roundIndex, player, value) {
            if (rounds[roundIndex]) {
                const newValue = parseInt(value) || 0;
                if (newValue < -500 || newValue > 1500) {
                    showNotification('Score moet tussen -500 en 1500 zijn!', 'warning');
                    return;
                }
                rounds[roundIndex][player] = newValue;
                updateDisplay();
                saveGame();
            }
        }

        function adjustScore(roundIndex, player, change) {
            if (rounds[roundIndex]) {
                const currentScore = rounds[roundIndex][player] || 0;
                const newScore = currentScore + change;
                if (newScore < -500 || newScore > 1500) {
                    showNotification('Score limiet bereikt!', 'warning');
                    return;
                }
                rounds[roundIndex][player] = newScore;
                updateDisplay();
                saveGame();
            }
        }

        function addQuickScore(roundIndex, player, score) {
            if (rounds[roundIndex]) {
                const currentScore = rounds[roundIndex][player] || 0;
                const newScore = currentScore + score;
                if (newScore < -500 || newScore > 1500) {
                    showNotification('Score limiet bereikt!', 'warning');
                    return;
                }
                rounds[roundIndex][player] = newScore;
                updateDisplay();
                saveGame();
            }
        }

        function getPlayerTotal(player) {
            return rounds.reduce((total, round) => total + (round[player] || 0), 0);
        }

        function getScoreClass(total) {
            if (total >= 1000) return 'winner';
            if (total >= 950 && total < 1000) return 'close-to-win';
            return '';
        }

        function getStatusText(total) {
            if (total >= 1000) return 'WINNAAR! üèÜ';
            if (total >= 950 && total < 1000) return 'Bijna! üî•';
            return '';
        }

        // Enhanced view toggle with shake support
        function toggleView() {
            currentView = currentView === 'cards' ? 'table' : 'cards';
            const toggleBtn = document.getElementById('viewToggle');
            if (currentView === 'table') {
                toggleBtn.textContent = 'üì± Kaart Weergave';
            } else {
                toggleBtn.textContent = 'üìä Tabel Weergave';
            }
            updateDisplay();
            
            // Save preference
            localStorage.setItem('duizenden_preferred_view', currentView);
        }

        // Load preferred view on startup
        function loadViewPreference() {
            const savedView = localStorage.getItem('duizenden_preferred_view');
            if (savedView && savedView !== currentView) {
                toggleView();
            }
        }

        function getLeaderRanking() {
            const totals = players.map(player => ({
                name: player,
                total: getPlayerTotal(player)
            }));
            
            totals.sort((a, b) => {
                if (a.total >= 1000 && b.total >= 1000) {
                    const aDistance = Math.abs(1000 - a.total);
                    const bDistance = Math.abs(1000 - b.total);
                    return aDistance - bDistance;
                }
                
                if (a.total >= 1000 && b.total < 1000) return -1;
                if (b.total >= 1000 && a.total < 1000) return 1;
                
                return b.total - a.total;
            });
            
            return totals;
        }

        function toggleRound(roundIndex, player) {
            const content = document.getElementById(`round-content-${roundIndex}-${player}`);
            const icon = document.getElementById(`accordion-icon-${roundIndex}-${player}`);
            const headerBtn = document.getElementById(`round-header-${roundIndex}-${player}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                headerBtn.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                headerBtn.classList.add('expanded');
            }
        }

        function getScoreDisplayClass(score) {
            if (score > 0) return 'positive';
            if (score < 0) return 'negative';
            return 'zero';
        }

        function generateTableView() {
            if (players.length === 0) {
                return '<div class="no-players">üëÜ Voeg spelers toe om te beginnen!</div>';
            }

            if (rounds.length === 0) {
                return '<div class="no-players">üéØ Voeg een ronde toe om scores te zien!</div>';
            }

            const ranking = getLeaderRanking();
            
            let html = '<div class="table-view">';
            html += '<table class="scores-table">';
            
            html += '<tr><th class="round-cell">Ronde</th>';
            players.forEach(player => {
                const rank = ranking.findIndex(r => r.name === player);
                let rankClass = '';
                if (rank === 0) rankClass = 'leader-1';
                else if (rank === 1) rankClass = 'leader-2';
                else if (rank === 2) rankClass = 'leader-3';
                
                html += `<th class="score-cell ${rankClass}">${player}</th>`;
            });
            html += '</tr>';

            rounds.forEach((round, roundIndex) => {
                html += '<tr>';
                html += `<td class="round-cell">R${roundIndex + 1}</td>`;
                
                players.forEach(player => {
                    const roundScore = round[player] || 0;
                    const runningTotal = rounds.slice(0, roundIndex + 1)
                        .reduce((sum, r) => sum + (r[player] || 0), 0);
                    
                    html += `
                        <td class="score-cell">
                            <div class="score-with-total">
                                <span class="round-score">${roundScore > 0 ? '+' : ''}${roundScore}</span>
                                <span class="running-total">(${runningTotal})</span>
                            </div>
                        </td>
                    `;
                });
                html += '</tr>';
            });

            html += '<tr class="total-row">';
            html += '<td>TOTAAL</td>';
            players.forEach(player => {
                const total = getPlayerTotal(player);
                let totalClass = '';
                if (total >= 1000) totalClass = 'winner-total';
                else if (total >= 950 && total < 1000) totalClass = 'close-total';
                
                html += `<td class="${totalClass}">${total}</td>`;
            });
            html += '</tr>';

            html += '</table>';
            html += '</div>';
            
            html += '<button class="btn btn-secondary" onclick="addRound()" style="margin-top: 16px;">üéØ Nieuwe Ronde</button>';
            
            return html;
        }

        function updateDisplay() {
            performance.mark('update-start');
            
            const gameContent = document.getElementById('gameContent');
            
            if (players.length === 0) {
                gameContent.innerHTML = '<div class="no-players">üëÜ Voeg spelers toe om te beginnen!</div>';
                return;
            }

            if (currentView === 'table') {
                gameContent.innerHTML = generateTableView();
                performance.mark('update-end');
                performance.measure('update-display', 'update-start', 'update-end');
                return;
            }

            if (rounds.length === 0) {
                addRound();
                return;
            }

            let html = '';
            
            if (rounds.length > 0) {
                html += `
                    <div class="rounds-header">
                        <div class="rounds-title">Scorebord</div>
                        <div class="round-counter">Ronde ${rounds.length}</div>
                    </div>
                `;
            }

            html += '<div class="players-grid">';

            players.forEach(player => {
                const total = getPlayerTotal(player);
                const scoreClass = getScoreClass(total);
                const statusText = getStatusText(total);
                
                html += `
                    <div class="player-card ${scoreClass}">
                        ${statusText ? `<div class="status-indicator status-${scoreClass.split('-')[0] || 'normal'}">${statusText}</div>` : ''}
                        <div class="player-header">
                            <div class="player-name">${player}</div>
                            <div class="player-total">${total}</div>
                            <button class="remove-player" onclick="removePlayer('${player}')" title="Verwijder speler">√ó</button>
                        </div>
                `;

                rounds.forEach((round, roundIndex) => {
                    const roundScore = round[player] || 0;
                    const isCurrentRound = roundIndex === rounds.length - 1;
                    const scoreClass = getScoreDisplayClass(roundScore);
                    
                    html += `
                        <div class="round-accordion ${isCurrentRound ? 'current-round' : ''}">
                            <button class="round-header-btn ${isCurrentRound ? 'expanded' : ''}" 
                                    id="round-header-${roundIndex}-${player}"
                                    onclick="toggleRound(${roundIndex}, '${player}')">
                                <div class="round-info">
                                    <span class="round-number">R${roundIndex + 1}</span>
                                    <span class="round-score-display ${scoreClass}">
                                        ${roundScore > 0 ? '+' : ''}${roundScore}
                                    </span>
                                </div>
                                <span class="accordion-icon ${isCurrentRound ? 'expanded' : ''}" 
                                      id="accordion-icon-${roundIndex}-${player}">‚ñº</span>
                            </button>
                            <div class="round-content ${isCurrentRound ? 'expanded' : ''}" 
                                 id="round-content-${roundIndex}-${player}">
                                <div class="score-input-container">
                                    <div class="score-controls">
                                        <button class="score-btn minus" onclick="adjustScore(${roundIndex}, '${player}', -5)">‚àí</button>
                                        <input type="number" 
                                               class="score-input" 
                                               value="${roundScore}"
                                               onchange="updateScore(${roundIndex}, '${player}', this.value)"
                                               min="-500" max="1500"
                                               inputmode="numeric">
                                        <button class="score-btn" onclick="adjustScore(${roundIndex}, '${player}', 5)">+</button>
                                    </div>
                                </div>
                                <div class="quick-scores">
                                    <button class="quick-score-btn" onclick="addQuickScore(${roundIndex}, '${player}', -50)">-50</button>
                                    <button class="quick-score-btn" onclick="addQuickScore(${roundIndex}, '${player}', -20)">-20</button>
                                    <button class="quick-score-btn" onclick="addQuickScore(${roundIndex}, '${player}', 20)">+20</button>
                                    <button class="quick-score-btn" onclick="addQuickScore(${roundIndex}, '${player}', 50)">+50</button>
                                    <button class="quick-score-btn" onclick="addQuickScore(${roundIndex}, '${player}', 100)">+100</button>
                                    <button class="quick-score-btn" onclick="addQuickScore(${roundIndex}, '${player}', 150)">+150</button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            html += '</div>';
            html += '<button class="btn btn-secondary" onclick="addRound()" style="margin-top: 16px;">üéØ Nieuwe Ronde</button>';

            gameContent.innerHTML = html;
            
            performance.mark('update-end');
            performance.measure('update-display', 'update-start', 'update-end');
        }

        function resetGame() {
            if (confirm('Weet je zeker dat je een nieuw spel wilt starten? Alle scores gaan verloren.')) {
                players = [];
                rounds = [];
                updateDisplay();
                saveGame();
                showNotification('Nieuw spel gestart! üéØ');
            }
        }

        // Enhanced input handling
        function setupInputHandlers() {
            const playerNameInput = document.getElementById('playerName');
            
            playerNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addPlayer();
                }
            });

            // Auto-focus on player input when appropriate
            playerNameInput.addEventListener('blur', function() {
                setTimeout(() => {
                    if (players.length === 0 && document.activeElement !== playerNameInput) {
                        playerNameInput.focus();
                    }
                }, 100);
            });

            // Handle paste events for bulk player addition
            playerNameInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const pastedText = e.target.value;
                    const names = pastedText.split(/[,\n\r\t]+/).map(name => name.trim()).filter(name => name);
                    
                    if (names.length > 1) {
                        e.target.value = '';
                        names.forEach(name => {
                            if (name && !players.includes(name) && players.length < 8) {
                                players.push(name);
                            }
                        });
                        
                        rounds.forEach(round => {
                            names.forEach(name => {
                                if (!round.hasOwnProperty(name)) {
                                    round[name] = 0;
                                }
                            });
                        });
                        
                        updateDisplay();
                        saveGame();
                        showNotification(`${names.length} spelers toegevoegd! üë•`);
                    }
                }, 0);
            });
        }

        // Enhanced keyboard shortcuts with shake detection controls
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + N for new game
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    resetGame();
                }
                
                // Ctrl/Cmd + S for manual save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveGame();
                    showNotification('Handmatig opgeslagen! üíæ');
                }
                
                // Ctrl/Cmd + Enter for new round
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (players.length > 0) {
                        addRound();
                    }
                }
                
                // V for toggle view
                if (e.key === 'v' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    toggleView();
                }
                
                // S for share
                if (e.key === 's' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    shareGame();
                }
                
                // M for toggle shake detection
                if (e.key === 'm' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    toggleShakeDetection();
                }

                // T for test shake sensitivity
                if (e.key === 't' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    testShakeSensitivity();
                }

                // + for increase shake sensitivity (more sensitive)
                if (e.key === '+' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    adjustShakeSensitivity(1);
                }

                // - for decrease shake sensitivity (less sensitive)
                if (e.key === '-' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    adjustShakeSensitivity(-1);
                }
                
                // H for help/shortcuts
                if (e.key === 'h' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    showKeyboardShortcuts();
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    closeShareModal();
                    closeWinnerModal();
                    closeKeyboardShortcuts();
                }
            });
        }

        function testShakeSensitivity() {
            if (!shakeDetector) {
                showNotification('Shake detectie niet beschikbaar', 'warning');
                return;
            }

            if (shakeDetector.testMode) {
                shakeDetector.stopTestMode();
            } else {
                shakeDetector.startTestMode();
            }
        }

        function adjustShakeSensitivity(direction) {
            if (!shakeDetector) {
                showNotification('Shake detectie niet beschikbaar', 'warning');
                return;
            }

            if (direction > 0) {
                shakeDetector.increaseSensitivity();
            } else {
                shakeDetector.decreaseSensitivity();
            }
        }

        function toggleShakeDetection() {
            if (!shakeDetector) {
                showNotification('Shake detectie niet beschikbaar op dit apparaat', 'warning');
                return;
            }

            if (!shakeDetector.isAvailable()) {
                showNotification('Shake detectie vereist HTTPS en mobiel apparaat', 'warning');
                return;
            }

            const status = shakeDetector.getStatus();
            console.log('üîç Current shake status:', status);

            if (status.enabled) {
                // Disable shake detection
                shakeDetector.disable();
                showNotification('Shake detectie uitgeschakeld üì±‚ùå');
                localStorage.setItem('duizenden_shake_enabled', 'false');
            } else {
                // Enable shake detection
                if (status.permission === 'denied') {
                    showNotification('Permissie geweigerd. Herstart Safari om opnieuw te proberen.', 'warning');
                    return;
                }

                // For iOS devices that need permission, init will request it
                // For others, it will just enable
                shakeDetector.init().then(success => {
                    if (success) {
                        showNotification('Shake detectie ingeschakeld üì±‚úÖ');
                        localStorage.setItem('duizenden_shake_enabled', 'true');
                    } else {
                        showNotification('Kon shake detectie niet inschakelen', 'error');
                    }
                });
            }
        }

        function showKeyboardShortcuts() {
            const shortcutsModal = document.createElement('div');
            shortcutsModal.id = 'shortcutsModal';
            shortcutsModal.className = 'share-modal';
            
            let shakeStatusText = '';
            let troubleshootingText = '';
            let sensitivityControls = '';
            
            if (shakeDetector) {
                const status = shakeDetector.getStatus();
                if (!status.available) {
                    shakeStatusText = '<p>‚Ä¢ ‚ùå <strong>Niet beschikbaar</strong> (HTTPS + mobiel vereist)</p>';
                    troubleshootingText = `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                            <p><strong>üîß Troubleshooting:</strong></p>
                            <p style="font-size: 0.9rem; margin-top: 8px;">
                                1. Zorg voor HTTPS verbinding<br>
                                2. Gebruik een mobiel apparaat<br>
                                3. Update je browser naar nieuwste versie
                            </p>
                        </div>
                    `;
                } else if (status.permission === 'denied') {
                    shakeStatusText = '<p>‚Ä¢ ‚ùå <strong>Permissie geweigerd</strong> (herstart Safari)</p>';
                } else if (status.enabled) {
                    shakeStatusText = `<p>‚Ä¢ ‚úÖ <strong>Ingeschakeld</strong> - gevoeligheid: ${status.sensitivity}</p>`;
                    
                    sensitivityControls = `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(139, 195, 74, 0.1); border-radius: 8px; border-left: 3px solid #8bc34a;">
                            <p><strong>üéõÔ∏è Gevoeligheid aanpassen:</strong></p>
                            <p style="font-size: 0.9rem; margin-top: 8px;">
                                ‚Ä¢ <kbd>T</kbd> - Test modus (10 sec)<br>
                                ‚Ä¢ <kbd>+</kbd> - Gevoeliger maken<br>
                                ‚Ä¢ <kbd>-</kbd> - Minder gevoelig maken<br>
                                ‚Ä¢ Huidige waarde: <strong>${status.sensitivity}</strong> (2=zeer gevoelig, 25=weinig gevoelig)
                            </p>
                            <p style="font-size: 0.85rem; margin-top: 8px; color: #64748b;">
                                üí° <strong>Tip:</strong> Een lichte pols-beweging zou genoeg moeten zijn!
                            </p>
                        </div>
                    `;
                } else {
                    const needsPermission = typeof DeviceMotionEvent.requestPermission === 'function';
                    shakeStatusText = needsPermission 
                        ? '<p>‚Ä¢ ‚è≥ <strong>Beschikbaar</strong> - druk M om in te schakelen</p>'
                        : '<p>‚Ä¢ üîÑ <strong>Beschikbaar</strong> - druk M om in te schakelen</p>';
                    
                    // Add troubleshooting for Android devices
                    if (status.debugInfo?.userAgent?.includes('Android')) {
                        troubleshootingText = `
                            <div style="margin-top: 15px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 3px solid #f59e0b;">
                                <p><strong>üì± Android Tips:</strong></p>
                                <p style="font-size: 0.9rem; margin-top: 8px;">
                                    ‚Ä¢ Controleer Chrome > Instellingen > Privacy > Sensoren<br>
                                    ‚Ä¢ Herlaad de pagina na het inschakelen<br>
                                    ‚Ä¢ Samsung apparaten hebben mogelijk geen gyroscoop<br>
                                    ‚Ä¢ <button onclick="window.debugShake?.()" style="background: #f59e0b; color: white; border: none; padding: 4px 8px; border-radius: 4px; margin-top: 4px;">üî¨ Run Diagnostics</button>
                                </p>
                            </div>
                        `;
                    }
                }
            } else {
                shakeStatusText = '<p>‚Ä¢ ‚ùå <strong>Niet ondersteund</strong></p>';
            }

            shortcutsModal.innerHTML = `
                <div class="share-modal-content" onclick="event.stopPropagation()">
                    <h3>‚å®Ô∏è Sneltoetsen & Bediening</h3>
                    <div style="text-align: left; line-height: 1.8; margin: 20px 0;">
                        <p><strong>Algemeen:</strong></p>
                        <p>‚Ä¢ <kbd>V</kbd> - Wissel tussen kaart/tabel weergave</p>
                        <p>‚Ä¢ <kbd>S</kbd> - Deel scores</p>
                        <p>‚Ä¢ <kbd>H</kbd> - Toon deze help</p>
                        <p>‚Ä¢ <kbd>Ctrl+N</kbd> - Nieuw spel</p>
                        <p>‚Ä¢ <kbd>Ctrl+S</kbd> - Handmatig opslaan</p>
                        <p>‚Ä¢ <kbd>Ctrl+Enter</kbd> - Nieuwe ronde</p>
                        <p>‚Ä¢ <kbd>Escape</kbd> - Sluit vensters</p>
                        
                        <p style="margin-top: 15px;"><strong>Mobiel - Shake Detectie:</strong></p>
                        <p>‚Ä¢ <kbd>M</kbd> - Schakel shake detectie in/uit</p>
                        ${shakeStatusText}
                        
                        ${sensitivityControls}
                        ${troubleshootingText}
                        
                        ${shakeDetector && shakeDetector.isAvailable() ? `
                        <p style="margin-top: 10px; font-size: 0.9rem; color: #94a3b8;">
                            <strong>iOS:</strong> Druk M en geef permissie.<br>
                            <strong>Android:</strong> Druk M om in te schakelen.<br>
                            <strong>Shake kracht:</strong> Lichte pols-beweging is genoeg!
                        </p>
                        ` : ''}
                    </div>
                    <button class="btn" onclick="closeKeyboardShortcuts()" style="width: 100%;">Sluiten</button>
                </div>
            `;
            
            shortcutsModal.onclick = closeKeyboardShortcuts;
            document.body.appendChild(shortcutsModal);
        }

        function closeKeyboardShortcuts() {
            const modal = document.getElementById('shortcutsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Enhanced auto-save with debouncing
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveGame();
            }, 500);
        }

        // Game statistics
        function getGameStatistics() {
            if (players.length === 0 || rounds.length === 0) return null;
            
            const stats = {
                totalRounds: rounds.length,
                totalPlayers: players.length,
                averageScore: 0,
                highestScore: -Infinity,
                lowestScore: Infinity,
                gameStarted: null,
                gameEnded: null,
                winner: null
            };
            
            let totalScore = 0;
            let scoreCount = 0;
            
            players.forEach(player => {
                const playerTotal = getPlayerTotal(player);
                totalScore += playerTotal;
                scoreCount++;
                
                if (playerTotal > stats.highestScore) {
                    stats.highestScore = playerTotal;
                }
                if (playerTotal < stats.lowestScore) {
                    stats.lowestScore = playerTotal;
                }
                
                if (playerTotal >= 1000 && !stats.winner) {
                    stats.winner = player;
                }
            });
            
            stats.averageScore = Math.round(totalScore / scoreCount);
            
            // Try to get timestamps from localStorage
            try {
                const gameData = JSON.parse(localStorage.getItem('duizenden_game'));
                if (gameData && gameData.timestamp) {
                    stats.gameStarted = new Date(gameData.timestamp);
                }
            } catch (e) {}
            
            return stats;
        }

        // Advanced error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showNotification('Er is een fout opgetreden', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showNotification('Er is een fout opgetreden', 'error');
        });

        // Initialize enhanced PWA
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize PWA features
            new DuizendenPWA();
            
            // Setup enhanced input handling
            setupInputHandlers();
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Load game data
            loadGame();
            
            // Load view preference
            loadViewPreference();
            
            // Load shake detection preference
            loadShakePreference();
            
            // Initialize display
            if (players.length === 0) {
                updateDisplay();
                // Auto-focus on player input for better UX
                setTimeout(() => {
                    document.getElementById('playerName').focus();
                }, 100);
            }
            
            // Auto-save on visibility change (user switching tabs/apps)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    saveGame();
                }
            });
            
            // Auto-save on page unload
            window.addEventListener('beforeunload', function() {
                saveGame();
            });
            
            // Check for updates periodically (only when online)
            setInterval(() => {
                if (navigator.onLine && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ command: 'checkForUpdates' });
                }
            }, 60000); // Check every minute
            
            console.log('üéØ Duizenden PWA loaded successfully!');
            console.log('‚úÖ Fully offline capable - no internet required!');
            console.log('üì± Shake detection available on mobile devices!');
            
            // Show offline capability message on first load
            if (!localStorage.getItem('duizenden_offline_message_shown')) {
                setTimeout(() => {
                    showNotification('üî• Deze app werkt 100% offline! Geen internet nodig.', 'success');
                    localStorage.setItem('duizenden_offline_message_shown', 'true');
                }, 2000);
            }
        });

        function loadShakePreference() {
            if (shakeDetector && shakeDetector.isAvailable()) {
                const shakeEnabled = localStorage.getItem('duizenden_shake_enabled');
                console.log('üì± Loading shake preference:', shakeEnabled);
                
                if (shakeEnabled === 'true') {
                    // Try to enable shake detection based on saved preference
                    // This will handle permission appropriately
                    setTimeout(() => {
                        toggleShakeDetection();
                    }, 1000);
                }
            }
        }

        // Export for debugging (development only)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.duizendenDebug = {
                players,
                rounds,
                shakeDetector,
                getGameStatistics,
                loadGame,
                saveGame,
                toggleShakeDetection,
                resetGame: () => {
                    players = [];
                    rounds = [];
                    updateDisplay();
                    saveGame();
                },
                simulateShake: () => {
                    if (shakeDetector && shakeDetector.shakeEnabled) {
                        console.log('üß™ Simulating shake event...');
                        shakeDetector.onShake();
                    } else {
                        console.log('‚ùå Shake detector not enabled');
                    }
                },
                getShakeStatus: () => {
                    return shakeDetector ? shakeDetector.getStatus() : null;
                },
                testShakePermission: async () => {
                    if (shakeDetector) {
                        console.log('üß™ Testing shake permission...');
                        return await shakeDetector.init();
                    }
                    return false;
                },
                runShakeDiagnostics: async () => {
                    if (shakeDetector) {
                        return await shakeDetector.runDiagnostics();
                    }
                    return null;
                }
            };
        }

        // Global debug function for easier testing
        window.debugShake = async () => {
            if (shakeDetector) {
                const diagnostics = await shakeDetector.runDiagnostics();
                console.table(diagnostics.environment);
                console.log('Full diagnostics:', diagnostics);
                
                // Show user-friendly diagnostic info
                let message = 'üî¨ Shake Diagnostics:\n\n';
                message += `Device: ${diagnostics.environment.userAgent.split(' ')[0]}\n`;
                message += `HTTPS: ${diagnostics.httpsCheck ? '‚úÖ' : '‚ùå'}\n`;
                message += `DeviceMotion: ${diagnostics.deviceMotionAvailable ? '‚úÖ' : '‚ùå'}\n`;
                message += `Events firing: ${diagnostics.eventTest ? '‚úÖ' : '‚ùå'}\n`;
                message += `Enabled: ${diagnostics.currentStatus.enabled ? '‚úÖ' : '‚ùå'}\n`;
                message += `Sensitivity: ${diagnostics.currentStatus.sensitivity}\n\n`;
                
                if (!diagnostics.eventTest) {
                    message += 'Troubleshooting:\n';
                    message += '1. Controleer of je op HTTPS bent\n';
                    message += '2. Herlaad de pagina\n';
                    message += '3. Controleer browser instellingen > Privacy > Sensoren\n';
                    message += '4. Probeer een andere browser\n\n';
                } else {
                    message += 'Test de gevoeligheid:\n';
                    message += '‚Ä¢ Druk T voor test modus\n';
                    message += '‚Ä¢ Druk + om gevoeliger te maken\n';
                    message += '‚Ä¢ Druk - om minder gevoelig te maken\n\n';
                }
                
                message += 'Hoe hard schudden:\n';
                message += '‚Ä¢ Een lichte pols-beweging zou genoeg moeten zijn\n';
                message += '‚Ä¢ Niet te hard - telefoon vasthouden!\n';
                message += '‚Ä¢ Test met T-toets om ideale kracht te vinden';
                
                alert(message);
                return diagnostics;
            }
            alert('Shake detector not initialized');
            return null;
        };
    </script>
</body>
</html>
